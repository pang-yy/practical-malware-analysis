## Analyzing Malicious Windows Programs

_Non-malicious programs are generally well formed by compilers and follow Microsoft guidelines, but malware is typically poorly formed and tends to perform unexpected actions. This chapter will cover some unique ways that malware uses Windows functionality._

- [Analyzing Malicious Windows Programs](#analyzing-malicious-windows-programs)
  - [Windows API](#windows-api)
    - [Types and Hungarian Notation](#types-and-hungarian-notation)
    - [Handles](#handles)
    - [Common file system functions](#common-file-system-functions)
    - [Special Files](#special-files)
  - [Windows Registry](#windows-registry)
    - [Root keys](#root-keys)
    - [Common registry functions](#common-registry-functions)
    - [Analyzing Registry Code in Practice](#analyzing-registry-code-in-practice)
  - [Networking APIs](#networking-apis)
  - [Following Running Malware](#following-running-malware)
  - [Kernel vs User Mode](#kernel-vs-user-mode)
  - [Native API](#native-api)


### Windows API

#### Types and Hungarian Notation

- Windows uses *Hungarian notation* for API function identifiers
  - Format: `[data_type][variable_name]`
  - Example: `dwSize` is a `DWORD` type
  - Windows API uses its own names to represent C types (`WORD`, `DWORD`, ..., rather than `int`, `long`, ...)

|Type and prefix|Description|
|---|---|
|WORD (w)|A 16-bit unsigned value.|
|DWORD (dw)|A double-WORD, 32-bit unsigned value.|
|Handles (H)|A reference to an object. The information stored in the handle is not documented, and the handle should be manipulated only by the Windows API. Examples include HModule, HInstance, and HKey.|
|Long Pointer (LP)|A pointer to another type. For example, LPByte is a pointer to a byte, and LPCSTR is a pointer to a character string. Strings are usually prefixed by LP because they are actually pointers. Occasionally, you will see Pointer (P)... prefixing another type instead of LP; in 32-bit systems, this is the same as LP. The difference was meaningful in 16-bit systems.|
|Callback|Represents a function that will be called by the Windows API. For example, the InternetSetStatusCallback function passes a pointer to a function that is called whenever the system has an update of the Internet status.|

#### Handles

- **Handles** are items that have been opened or created in the OS
  - Example: window, process, module, menu, file, ...
  - similar to pointers, but 
    - cannot be used in arithmetic operations
    - do not always represent the objectâ€™s address
  - can store and use it later to refer to the same object

####  Common file system functions

- [`CreateFile`](appendix-a.md#createfile)
- [`ReadFile`](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile) and [`WriteFile`](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile)
- [`CreateFileMapping`](appendix-a.md#createfilemapping) and [`MapViewOfFile`](appendix-a.md#mapviewoffile)
- refer [appendix a](appendix-a.md) for detailed explanation

#### Special Files
  - ***shared files***
    -  directories or files in a shared folder stored on a network
    - files' name start with `\\serverName\share` or `\\?\serverName\share`
    - `\\?\` prefix tells the OS to disable all string parsing, and it allows access to longer filenames
  - ***files accessible via namespaces***
  - ***alternate data streams (ADS)***
    - file attribute only found on the *NTFS file system*
    - these extra data:
      - does not show up in a directory listing
      - does not show up when displaying the contents of the file
    - malware like to use ADS to hide data
    - experiment with data stream (using Powershell)
      - add stream to file: `set-content -path "file_path" -stream "name_of_stream"`
      - read ADS: `get-item -path "file_path" -stream *`
      - remove ADS: `remove-item -path "file_path" -stream "name_of_stream"`
    - recommend reading: [Introduction to Alternate Data Streams](https://www.malwarebytes.com/blog/news/2015/07/introduction-to-alternate-data-streams)

### Windows Registry

- **Key**: *key* is a folder in the registry that can contain additional folders or values
- **Root key**: registry is divided into five top-level sections called *root keys*
- **Subkey**: *subkey* is *key* within a *key* (like subfolder is folder within folder)
- **Value entry**: *value entry* is an ordered pair with a name and value
- **Value/Data**: *value*/*data* is the data stored in a registry entry
- malware can modify registry through `.reg` scripts or by programmatically editing it directly

#### Root keys

|Root Keys|Description|
|---|---|
|KEY_LOCAL_MACHINE (HKLM)|Stores settings that are global to the local machine|
|HKEY_CURRENT_USER (HKCU)|Stores settings specific to the current user |
|HKEY_CLASSES_ROOT|Stores information defining types|
|HKEY_CURRENT_CONFIG|Stores settings about the current hardware configuration, specifically differences between the current and the standard configuration|
|HKEY_USERS|Defines settings for the default user, new users, and current users|

HKCU is actually a virtual key, the actual key is stored in HKEY_USERS/*SID*, where SID is the security identifier of the user currently logged in

#### Common registry functions

- [`RegOpenKeyEx`](appendix-a.md#regopenkey)
- `RegSetValueEx`: adds a new value to the registry and sets its data
- `RegGetValue`: returns the data for a value entry in the registry
- refer [appendix a](appendix-a.md) for detailed explanation

#### Analyzing Registry Code in Practice

The assembly code below shows a malware opening the Run key from the registry and adding a value so that the program runs each time Windows starts:

*most* comments showname of the parameter being pushed on the stack

```asm
0040286F    push    2                   ; samDesired
00402871    push    eax                 ; ulOptions
00402872    push    offset SubKey       ; "Software\\Microsoft\\Windows\\CurrentVersion\\Run"
00402877    push    HKEY_LOCAL_MACHINE  ; hKey
0040287C    call    esi                 ; RegOpenKeyExW
0040287E    test    eax, eax
00402880    jnz     short loc_4028C5
00402882    
00402882  loc_402882:
00402882    lea     ecx, [esp+424h+Data]
00402886    push    ecx                 ; lpString
00402887    mov     bl, 1
00402889    call    ds:lstrlenW
0040288F    lea     edx, [eax+eax+2]
00402893    push    edx                 ; cbData
00402894    mov     edx, [esp+428h+hKey]
00402898    lea     eax, [esp+428h+Data]
0040289C    push    eax                 ; lpData
0040289D    push    1                   ; dwType
0040289F    push    0                   ; Reserved
004028A1    lea     ecx, [esp+434h+ValueName]
004028A8    push    ecx                 ; lpValueName
004028A9    push    edx                 ; hKey
004028AA    call    ds:RegSetValueExW
```

### Networking APIs


### Following Running Malware


### Kernel vs User Mode


### Native API